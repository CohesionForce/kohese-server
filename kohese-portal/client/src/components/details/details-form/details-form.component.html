<div style="height: 100%;">
  <ng-container *ngIf="(proxyStream | async)">
    <form [formGroup]="formGroup"
      novalidate class="form-group">
      <ng-container *ngFor="let property of (type.fields | mapKey)">
        <ng-container *ngIf="type.fields[property].views['form']">
          <ng-container
            [ngSwitch]="type.fields[property].views['form'].inputType.type">
            <k-text *ngSwitchCase="'text'"
              [formGroup]="formGroup" [fieldId]="property"
              [fieldName]="type.fields[property].views['form'].displayName"
              [isMultiLine]="type.fields[property].views['form'].inputType.options['isMultiLine']">
            </k-text>
            <k-proxy-selector *ngSwitchCase="'proxy-selector'"
              [proxyContext]="itemProxy"
              [formGroup]="formGroup" [fieldId]="property"
              [type]="type.fields[property].views['form'].inputType.options['type']"
              [fieldName]="type.fields[property].views['form'].displayName"
              [allowMultiSelect]="type.fields[property].views['form'].inputType.options['allowMultiSelect']"
              [editableStream]="editableStream">
            </k-proxy-selector>
            <k-date *ngSwitchCase="'date'"
              [formGroup]="formGroup" [fieldId]="property"
              [fieldName]="type.fields[property].views['form'].displayName">
            </k-date>
            <k-select *ngSwitchCase="'select'"
              [formGroup]="formGroup" [fieldId]="property"
              [fieldName]="type.fields[property].views['form'].displayName"
              [options]="type.fields[property].views['form'].inputType.options['options']">
            </k-select>
            <k-user-selector *ngSwitchCase="'user-selector'"
              [formGroup]="formGroup" [fieldId]="property"
              [fieldName]="type.fields[property].views['form'].displayName">
            </k-user-selector>
            <k-markdown *ngSwitchCase="'markdown'"
              [formGroup]="formGroup" [fieldId]="property"
              [fieldName]="type.fields[property].views['form'].displayName"
              [editableStream]="editableStream"></k-markdown>
            <ng-container *ngSwitchCase="'reference'">
              <ng-container *ngIf="Array.isArray(type.dataModelProxy.item.
                properties[property].type)">
                <div style="display: flex; flex-direction: column;">
                  <h3>
                    {{property}}
                  </h3>
                  <span class="flex-right-align">
                    <button mat-icon-button
                      matTooltip="Add a value to {{property}}"
                      [disabled]="!(editableStream | async)"
                      (click)="addValue(property)">
                      <mat-icon class="fa fa-plus"></mat-icon>
                    </button>
                  </span>
                  <mat-list>
                    <ng-container *ngFor="let value of (proxyStream | async).
                      item[property]; let j = index">
                      <mat-list-item>
                        {{getTypeName(type.dataModelProxy.item.properties[
                          property].type)}}
                        <span class="flex-right-align">
                          <button mat-icon-button matTooltip="Edit this value"
                            [disabled]="!(editableStream | async)"
                            (click)="editValue(j, property)">
                            <mat-icon class="fa fa-edit"></mat-icon>
                          </button>
                          <button mat-icon-button
                            matTooltip="Remove this value"
                            [disabled]="!(editableStream | async)"
                            (click)="removeValue(j, property)">
                            <mat-icon class="fa fa-trash"></mat-icon>
                          </button>
                        </span>
                      </mat-list-item>
                    </ng-container>
                  </mat-list>
                </div>
              </ng-container>
              <ng-container *ngIf="!Array.isArray(type.dataModelProxy.item.
                properties[property].type)">
                <label>
                  {{property}}:&nbsp;
                </label>
                <button mat-raised-button matTooltip="Edit this value"
                  [disabled]="!(editableStream | async)"
                  (click)="openObjectEditor(property)">
                  {{getTypeName(type.dataModelProxy.item.properties[property].
                    type)}}
                </button>
              </ng-container>
            </ng-container>
            <br/>
          </ng-container>
        </ng-container>
      </ng-container>
    </form>
    <div id="detailsFormStateEditorContainer">
      <k-state-editor [itemProxy]="(proxyStream | async)"
        [disableTransitioning]="!(editableStream | async)"
        (stateChanged)="whenNonFormFieldChanges($event.fieldName, $event.candidate)">
      </k-state-editor>
    </div>
  </ng-container>
</div>
